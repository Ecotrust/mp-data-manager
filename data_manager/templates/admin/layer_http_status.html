<!-- filepath: /Users/dpollard/projects/madrona-apps/madrona-apps/mp-data-manager/templates/admin/layer_http_status.html -->
{% extends "admin/base_site.html" %}
{% block content %}
<style>
    .success {
        color: lightgreen;
    }
    .fail {
        background-color: lightcoral;
    }
</style>

<table id="layer-status-table">
    <thead>
        <tr>
            <th>Name</th>
            <th>URL</th>
            <th>HTTP Status</th>
        </tr>
    </thead>
    <tbody>
        {% for layer in layers %}
        <tr data-url="{{ layer.url }}" data-name="{{ layer.name }}">
            <td>{{ layer.name }}</td>
            <td>{{ layer.url }}</td>
            <td class="http-status">Loading...</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
    async function fetchStatus(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                console.error('Network response was not ok');
                //throw new Error('Network response was not ok');
            }
            const status = await response;
            return status;
            // const data = await response.json();
            // return data.status;
        } catch (error) {
            console.error('Fetch error:', error);
            return 'Fail';
        }
    }
    
    {% comment %} async function updateStatuses() {
        const rows = document.querySelectorAll('#layer-status-table tbody tr');
        for (const row of rows) {
            const url = row.getAttribute('data-url');
            const status = await fetchStatus(url);
            if (status) {
                console.log('Status:', status);
                row.querySelector('.http-status').textContent = `Success ${status.status}`;
    } else {
    console.log('Failed to fetch status');
    row.querySelector('.http-status').textContent = 'Fail';
    }
    // row.querySelector('.http-status').textContent = status === 200 ? 'Success' : 'Fail';
    }
    } {% endcomment %}
    
    async function fetchLayerStatuses() {
        const response = await fetch('/django-admin/data_manager/layer/get-layer-statuses/');
        const data = await response.json();
        for (const [layer, url] of Object.entries(data)) {
            const status = '';
            fetchStatus(url).then(status => {
                if (status) {
                    console.log('Status:', status);
                    status = `Success ${status.status}`;
                    const row = document.querySelector(`[data-name="${layer}"]`) 
                    if (row) {
                        const cell = row.querySelector('.http-status');
                        cell.textContent = `Success ${status.status}`;
                        cell.classList.add('success');
                    }
                    // statusElement.classList.add('success');
                    // statusElement.textContent = `${status} - ${layer}`;
                    // statusContainer.appendChild(statusElement);
                } else {
                    console.log('Failed to fetch status');
                    status = 'Fail';
                    const row = document.querySelector(`[data-name="${layer}"]`) 
                    if (row) {
                        const cell = row.querySelector('.http-status');
                        cell.textContent = 'Fail';
                        cell.classList.add('fail');
                    }
                }
            }) 
        }
    }
    
    document.addEventListener('DOMContentLoaded', fetchLayerStatuses);
</script>
{% endblock %}

{% comment %} async function fetchStatus(url) {
try {
const response = await fetch(url);
if (!response.ok) {
throw new Error('Network response was not ok');
}
const status = await response;
return status;
} catch (error) {
console.error('Fetch error:', error);
return null;
}
}
async function fetchLayerStatuses() {
const response = await fetch('/django-admin/data_manager/layer/get-layer-statuses/');
const data = await response.json();
const statusContainer = document.getElementById('status-container');
statusContainer.innerHTML = '';
for (const [layer, url] of Object.entries(data)) {
const status = '';
fetchStatus(url).then(status => {
if (status) {
console.log('Status:', status);
status = `Success ${status.status}`;
const statusElement = document.createElement('div');
statusElement.classList.add('success');
statusElement.textContent = `${status} - ${layer}`;
statusContainer.appendChild(statusElement);
} else {
console.log('Failed to fetch status');
status = 'Fail';
const statusElement = document.createElement('div');
statusElement.classList.add('fail');
statusElement.textContent = `${status} - ${layer}`;
statusContainer.appendChild(statusElement);
}
}) 
}
}

document.addEventListener('DOMContentLoaded', () => {
fetchLayerStatuses();
}); {% endcomment %}